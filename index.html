<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Solar Choices: On-Grid, Off-Grid & Net-Metering</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--ink:#0f172a;--muted:#64748b;--pill:#e2e8f0;}
    html,body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    .tab-btn{border-bottom:2px solid transparent}
    .tab-btn[aria-selected="true"]{color:#0f172a;border-color:#0f172a;font-weight:700}
    .container-narrow{max-width:1100px}
    .hint{background:linear-gradient(0deg,#f8fafc,#fff);border:1px dashed #cbd5e1}
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="bg-white border-b border-slate-200">
    <div class="mx-auto container-narrow px-6 py-6">
      <h1 class="text-2xl md:text-3xl font-bold">Solar Choices: On-Grid, Off-Grid & Net-Metering</h1>
      <p class="text-slate-600 mt-1">Understand your options, explore policy trade-offs, and run numbers with an interactive tool.</p>
    </div>
  </header>

  <!-- Tabs -->
  <nav class="mx-auto container-narrow px-6 pt-4">
    <div id="tabs" class="flex flex-wrap gap-3">
      <button class="tab-btn px-3 pb-2" data-tab="overview" aria-selected="true">Overview</button>
      <button class="tab-btn px-3 pb-2" data-tab="net" aria-selected="false">How Net Metering Works</button>
      <button class="tab-btn px-3 pb-2" data-tab="cases" aria-selected="false">Case Studies</button>
      <button class="tab-btn px-3 pb-2" data-tab="policy" aria-selected="false">Policy & Tips</button>
      <button class="tab-btn px-3 pb-2" data-tab="tool" aria-selected="false">Tool</button>
    </div>
  </nav>

  <!-- Content -->
  <main class="mx-auto container-narrow px-6 py-6 space-y-10">
    <!-- Overview -->
    <section id="panel-overview" class="space-y-4">
      <h2 class="text-xl font-semibold">Overview</h2>
      <p class="text-slate-700">
        Compare a <span class="font-semibold">net-zero grid-tied</span> design (sized to offset a year of use via credits) with a <span class="font-semibold">fully off-grid</span> design (PV + batteries sized for autonomy). Enter your load, site irradiance, component specs, and grid economics; the tool sizes arrays, batteries, and inverters, then estimates CAPEX and LCOE for each path.
      </p>

      <div class="grid md:grid-cols-3 gap-4">
        <div class="rounded-xl bg-white border border-slate-200 p-4">
          <h3 class="font-semibold mb-1">Grid-Tied (Net-Zero)</h3>
          <p class="text-slate-600 text-sm">Targets ~100% annual offset; highly policy-sensitive (buy/sell rates).</p>
        </div>
        <div class="rounded-xl bg-white border border-slate-200 p-4">
          <h3 class="font-semibold mb-1">Off-Grid</h3>
          <p class="text-slate-600 text-sm">PV + storage sized for autonomy; higher CAPEX but independence.</p>
        </div>
        <div class="rounded-xl bg-white border border-slate-200 p-4">
          <h3 class="font-semibold mb-1">Decision Hook</h3>
          <p class="text-slate-600 text-sm">If grid extension is costly, off-grid may pencil out despite higher LCOE.</p>
        </div>
      </div>
    </section>

    <!-- Net Metering -->
    <section id="panel-net" class="hidden space-y-4">
      <h2 class="text-xl font-semibold">How Net Metering Works</h2>
      <p class="text-slate-700">
    Net metering allows solar owners to stay connected to the utility grid while offsetting their electricity bills. 
    Your system’s meter tracks both <em>imports</em> (electricity you use from the grid) and <em>exports</em> 
    (excess energy you send back). The utility then applies credits to your bill based on these energy flows.
  </p>

  <div class="rounded-xl bg-white border border-slate-200 p-4">
    <h3 class="font-semibold mb-2">Step-by-Step Energy Flow</h3>
    <ol class="list-decimal pl-5 space-y-1 text-slate-700 text-sm">
      <li><strong>Generation:</strong> Your PV array produces DC power, converted to AC by the inverter.</li>
      <li><strong>Self-Use:</strong> The home consumes this solar power instantly when available.</li>
      <li><strong>Export:</strong> Surplus solar energy is exported to the grid and tracked by a bi-directional meter.</li>
      <li><strong>Credit:</strong> Each exported kWh earns a credit at the <em>sell rate</em> (¢/kWh).</li>
      <li><strong>Import:</strong> When production is low (night or cloudy days), power is imported from the grid at the <em>buy rate</em>.</li>
      <li><strong>True-Up:</strong> At month or year end, your total imports and exports are reconciled by the utility.</li>
    </ol>
  </div>

  <div class="rounded-xl bg-slate-50 border border-slate-200 p-4">
    <h3 class="font-semibold mb-2">Bill or Credit Calculation</h3>
    <p class="text-sm text-slate-700">
      The calculator uses these rates to determine your bill outcome:
    </p>
    <pre class="text-sm bg-white border border-slate-200 p-3 rounded-md overflow-x-auto">
Annual Bill ($) = (Import kWh × Buy Rate) − (Export kWh × Sell Rate)
    </pre>
    <p class="text-sm text-slate-600">
      If the result is positive → you owe the utility.  
      If negative → you receive a credit.  
      When <em>Annual Production ≈ Annual Load</em>, the system achieves “Net Zero.”
    </p>
  </div>

  <div class="rounded-xl bg-white border border-slate-200 p-4">
    <h3 class="font-semibold mb-2">Example Scenario</h3>
    <p class="text-sm text-slate-700">
      Suppose a home uses <strong>10,000 kWh/yr</strong> and the PV system produces <strong>11,000 kWh/yr</strong>.  
      At a <strong>Buy Rate = $0.20/kWh</strong> and <strong>Sell Rate = $0.10/kWh</strong>:
    </p>
    <ul class="list-disc pl-6 text-sm text-slate-700 mt-2 space-y-1">
      <li>Export = 1,000 kWh → credit of $100</li>
      <li>Import = 0 kWh → no grid usage</li>
      <li>Annual Bill = −$100 (credit carried forward)</li>
    </ul>
    <p class="text-xs text-slate-500 mt-2">
      In this example, the household achieved net-positive generation; excess credits may roll over or expire depending on the utility’s true-up policy.
    </p>
  </div>

  <div class="rounded-xl bg-slate-50 border border-slate-200 p-4">
    <h3 class="font-semibold mb-2">Common Policy Variations</h3>
    <ul class="list-disc pl-6 text-sm text-slate-700 space-y-1">
      <li><strong>Full Retail Credit:</strong> Exports valued at the same rate as imports (traditional NEM 1.0).</li>
      <li><strong>Avoided Cost Credit:</strong> Lower sell rate (reflects utility’s wholesale value, e.g. NEM 3.0).</li>
      <li><strong>Monthly True-Up:</strong> Credits reset each month, favoring self-consumption.</li>
      <li><strong>Annual True-Up:</strong> Credits roll for 12 months, good for seasonal solar regions.</li>
    </ul>
  </div>

  <div class="rounded-xl bg-white border border-slate-200 p-4">
    <h3 class="font-semibold mb-2">Tips for Optimization</h3>
    <ul class="list-disc pl-6 text-sm text-slate-700 space-y-1">
      <li>Size PV slightly below total annual load if export credits are low.</li>
      <li>Use smart appliances or small batteries to shift solar use into evenings.</li>
      <li>Track local tariff updates—small changes in sell rate can change ROI.</li>
      <li>Compare hybrid (PV + battery) setups if you face low export rates.</li>
    </ul>
  </div>

  <p class="text-xs text-slate-500">
    Content adapted for educational comparison; always check your utility’s current net-metering and interconnection rules.
  </p>
    </section>

    <!-- Case Studies -->
    <section id="panel-cases" class="hidden space-y-6">
      <h2 class="text-xl font-semibold">Case Studies (Quick Read)</h2>

      <div class="rounded-2xl bg-white border border-slate-200 p-5">
        <h3 class="font-semibold">1) Off-Grid Cabin (8 kW + 48 kWh)</h3>
        <p class="text-slate-700 text-sm">
          Two days of autonomy, generator reserve for winter. Highest CAPEX; strong resilience.
        </p>
      </div>

      <div class="rounded-2xl bg-white border border-slate-200 p-5">
        <h3 class="font-semibold">2) Net-Zero Suburban Roof (10 kW)</h3>
        <p class="text-slate-700 text-sm">
          Sized by irradiance × performance ratio; bill impact depends on buy/sell rates.
        </p>
      </div>
    </section>

    <!-- Policy -->
    <section id="panel-policy" class="hidden space-y-4">
      <h2 class="text-xl font-semibold">Policy Landscape & Practical Tips</h2>
      <p class="text-slate-700">Lower export credits favor self-consumption or small batteries; generous credits favor larger grid-tie arrays.</p>
      <div class="grid md:grid-cols-3 gap-4">
        <div class="rounded-xl bg-white border border-slate-200 p-4">
          <h3 class="font-semibold mb-1">Check Tariffs</h3>
          <p class="text-slate-600 text-sm">Time-of-use and export credit rules can flip the answer.</p>
        </div>
        <div class="rounded-xl bg-white border border-slate-200 p-4">
          <h3 class="font-semibold mb-1">Backup Value</h3>
          <p class="text-slate-600 text-sm">Small batteries add resilience even on grid-tied systems.</p>
        </div>
        <div class="rounded-xl bg-white border border-slate-200 p-4">
          <h3 class="font-semibold mb-1">Extension Cost</h3>
          <p class="text-slate-600 text-sm">Remote sites: compare $/ft grid extension vs off-grid CAPEX.</p>
        </div>
      </div>
    </section>

    <!-- Tool -->
    <section id="panel-tool" class="hidden space-y-4">
      <h2 class="text-xl font-semibold">Solar Sizing & Cost Tool (Net-Zero vs Off-Grid)</h2>

      <div class="hint rounded-xl p-4 text-sm text-slate-700">
        <p class="font-semibold mb-2">How to find each input:</p>
        <ul class="list-disc pl-5 space-y-1">
          <li><span class="font-semibold">Load (kWh):</span> Use last 12 months of utility bills; sum kWh (or compute average daily = annual/365). Off-grid cabins: estimate from appliances × hours/day.</li>
          <li><span class="font-semibold">Solar irradiance (kWh/m²/day):</span> Use PVWatts (NREL) or Global Solar Atlas for your location. The tool multiplies by a Performance Ratio for losses.</li>
          <li><span class="font-semibold">Distance from grid & $/ft:</span> Ask the utility/contractor for line extension quote; rural overhead vs underground differs widely.</li>
          <li><span class="font-semibold">Panel details:</span> Module nameplate watts and price per module (or per W). Enter both; we’ll compute module count and installed $/W.</li>
          <li><span class="font-semibold">Battery:</span> Enter nominal voltage, Ah per battery (or kWh per unit), days of autonomy, DoD, and $/kWh (or pack price/size). Tool sizes bank kWh and estimates cost.</li>
          <li><span class="font-semibold">Inverter:</span> Peak kW needed (sum of coincident loads + surge factor) and $/kW. Off-grid inverters often cost more.</li>
          <li><span class="font-semibold">Buy/Sell rates:</span> Your tariff’s import rate and export credit (or tariff-specific $/kWh).</li>
          <li><span class="font-semibold">Installation:</span> Lump-sum labor/permits/inspection; add BOS if not in panel price.</li>
        </ul>
      </div>

      <div id="tool-root"></div>
      <p class="text-xs text-slate-500">Values last updated: <span id="updated-at">—</span></p>
    </section>
  </main>

  <footer class="mx-auto container-narrow px-6 pb-10 text-xs text-slate-500">
    Content adapted for educational comparison; use time-series tools and utility tariffs for final design.
  </footer>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tabs logic + last-updated date -->
  <script>
    const UPDATED_AT = new Date().toISOString().slice(0,10);
    const ua = document.getElementById('updated-at');
    if (ua) ua.textContent = UPDATED_AT;

    const tabButtons = document.querySelectorAll('#tabs .tab-btn');
    const panels = {
      overview: document.getElementById('panel-overview'),
      net: document.getElementById('panel-net'),
      cases: document.getElementById('panel-cases'),
      policy: document.getElementById('panel-policy'),
      tool: document.getElementById('panel-tool'),
    };
    function showTab(name){
      Object.entries(panels).forEach(([k,el]) => el.classList.toggle('hidden', k!==name));
      tabButtons.forEach(b => b.setAttribute('aria-selected', b.dataset.tab===name ? 'true':'false'));
      if(name==='tool' && !window.__toolMounted){ mountTool(); window.__toolMounted=true; }
      window.scrollTo({top:0,behavior:'smooth'});
    }
    tabButtons.forEach(b=>b.addEventListener('click',()=>showTab(b.dataset.tab)));
    showTab('overview');
  </script>

  <!-- Calculator (JSX run by Babel) -->
  <script type="text/babel">
    const {useMemo, useState} = React;

    // Small helpers
    const clampPos = (v, def=0)=>Number.isFinite(v) && v>=0 ? v : def;
    const CRF = (r,n)=>{ const rr=r; if(rr===0) return 1/Math.max(n,1); const t=Math.pow(1+rr,Math.max(n,1)); return (rr*t)/(t-1); };

    function App(){
      // ---------- Inputs ----------
      const [i, setI] = useState({
        // 1) Load
        annualLoadKWh: 10950,                 // or set avgDailyKWh; we sync both
        avgDailyKWh: 30,

        // 2) Location irradiance + losses
        irradiancePSH: 4.5,                   // kWh/m²/day ≈ peak sun hours
        performanceRatio: 0.75,               // wiring/temp/soiling/inverter

        // 3) Grid distance economics
        distanceFromGridFt: 800,
        costPerFoot: 20,

        // 4) Panels (size & cost) + BOS + install
        panelWatt: 400,                       // W per module
        panelPriceUSD: 180,                   // $ per module
        bosCostPerW: 0.6,                     // racking/wire/etc, $/Wdc
        installLumpSum: 3000,                 // permits/labor if not in $/W
        oversizeFactorOffGrid: 1.2,           // PV uplift for charging/seasonal

        // 5) Battery (V, Ah, DoD, $/kWh, days autonomy, eff)
        battVoltage: 48,                      // V (nominal bank)
        battAhPerUnit: 100,                   // Ah per unit (for info)
        battDoD: 80,                          // %
        battDaysAutonomy: 2,                  // days
        battRoundTripEff: 0.9,                // fraction
        batteryCostPerKWh: 350,               // $/kWh (rated kWh)

        // 6) Inverter (size & $/kW)
        inverterBuyKW: 10,                    // grid-tie inverter size (≈ PV kW)
        inverterCostPerKW: 180,               // grid-tie $/kW
        inverterOffGridKW: 8,                 // off-grid inverter/charger size
        inverterOffGridCostPerKW: 450,        // off-grid $/kW

        // 7) Grid buy/sell
        buyRate: 0.20,                        // $/kWh
        sellRate: 0.10,                       // $/kWh credit

        // 8) Financials
        discountRatePct: 6,
        analysisYears: 25,
        onmPctOfCapex: 1.0,                   // %/yr for PV/BOS/inverters
        generatorReservePerYear: 200          // off-grid annual reserve
      });

      // Keep daily/annual in sync gently
      const set = (k,v)=>{
        setI(s=>{
          const n = {...s,[k]:v};
          if(k==='annualLoadKWh') n.avgDailyKWh = clampPos(v/365, s.avgDailyKWh);
          if(k==='avgDailyKWh')   n.annualLoadKWh = clampPos(v*365, s.annualLoadKWh);
          return n;
        });
      };

      // ---------- Derived sizing ----------
      const out = useMemo(()=>{
        // Sanitize
        const annualLoad = clampPos(i.annualLoadKWh);
        const dailyLoad  = clampPos(i.avgDailyKWh);
        const PR         = Math.min(Math.max(i.performanceRatio,0.4),0.9);
        const PSH        = Math.max(i.irradiancePSH, 1e-6);  // kWh/m²/day ≈ sun hours

        // Energy yield per 1 kWdc per year
        const kWhPerKWyr = PSH * PR * 365;

        // ---- Net-zero grid-tie array size ----
        const pvKW_netzero = clampPos(annualLoad / Math.max(kWhPerKWyr,1e-6));
        const modules_net  = Math.ceil((pvKW_netzero*1000) / Math.max(i.panelWatt,1));
        const panelsCost_net = modules_net * clampPos(i.panelPriceUSD);
        const bosCost_net    = (pvKW_netzero*1000) * clampPos(i.bosCostPerW);
        const inverterKW_net = Math.max(i.inverterBuyKW, pvKW_netzero); // allow user override but ensure >= array
        const inverterCost_net = inverterKW_net * clampPos(i.inverterCostPerKW);
        const gridExtension = clampPos(i.distanceFromGridFt) * clampPos(i.costPerFoot);
        const capex_net = panelsCost_net + bosCost_net + inverterCost_net + clampPos(i.installLumpSum) + gridExtension;

        // Production for billing at net-zero sizing (≈ equals annual load)
        const annualProd_net = pvKW_netzero * kWhPerKWyr;
        const exportKWh_net = Math.max(0, annualProd_net - annualLoad);
        const importKWh_net = Math.max(0, annualLoad - annualProd_net);
        const annualBill_net = importKWh_net*i.buyRate - exportKWh_net*i.sellRate;

        // ---- Off-grid battery sizing ----
        // Required usable storage for autonomy days:
        const usableKWh_needed = dailyLoad * Math.max(i.battDaysAutonomy,0);
        // Rated bank kWh accounting for DoD and round-trip efficiency:
        const battDoD = Math.min(Math.max(i.battDoD/100, 0.3), 0.95);
        const rtEff   = Math.min(Math.max(i.battRoundTripEff, 0.7), 1);
        const bankRatedKWh = usableKWh_needed / Math.max(battDoD*rtEff, 1e-6);

        // Convert voltage/Ah info (for display only)
        const unitKWh_fromVAh = (i.battVoltage * i.battAhPerUnit)/1000; // kWh per "unit"
        const estUnits = unitKWh_fromVAh > 0 ? Math.ceil(bankRatedKWh / unitKWh_fromVAh) : 0;

        const batteryCapex = bankRatedKWh * clampPos(i.batteryCostPerKWh);

        // ---- Off-grid PV & inverter ----
        // Off-grid PV sized for daily load with oversize to charge bank & seasonal headroom
        const pvKW_off = clampPos( (dailyLoad * i.oversizeFactorOffGrid) / Math.max(PSH*PR,1e-6) );
        const modules_off = Math.ceil((pvKW_off*1000) / Math.max(i.panelWatt,1));
        const panelsCost_off = modules_off * clampPos(i.panelPriceUSD);
        const bosCost_off    = (pvKW_off*1000) * clampPos(i.bosCostPerW);
        const inverterKW_off = Math.max(i.inverterOffGridKW, dailyLoad/4); // rough guard; user controls this
        const inverterCost_off = inverterKW_off * clampPos(i.inverterOffGridCostPerKW);
        const capex_off = panelsCost_off + bosCost_off + inverterCost_off + batteryCapex + clampPos(i.installLumpSum); // no grid extension

        // ---- LCOE math (annualized cost / annual energy) ----
        const r = Math.max(i.discountRatePct/100, 0);
        const N = Math.max(Math.round(i.analysisYears), 1);
        const crf = CRF(r,N);

        const onmPct = Math.max(i.onmPctOfCapex/100,0);

        const annualOandM_net = onmPct*capex_net;
        const annualized_net  = capex_net*crf + annualOandM_net;
        const lcoe_net = annualized_net / Math.max(annualProd_net,1);

        // Battery replacement treatment: approximate via CRF on bank with life = min(N, lifeGuess)
        const battLifeGuess = 12; // you can expose if desired
        const battCRF = CRF(r, Math.min(N, battLifeGuess));
        const annualOandM_off = onmPct*(capex_off - batteryCapex) + clampPos(i.generatorReservePerYear);
        const annualized_off  = (capex_off - batteryCapex)*crf + (batteryCapex*battCRF) + annualOandM_off;
        const annualProd_off  = pvKW_off * kWhPerKWyr; // average-year energy available
        const lcoe_off = annualized_off / Math.max(annualProd_off,1);

        return {
          // Net-zero
          pvKW_netzero, modules_net, inverterKW_net,
          panelsCost_net, bosCost_net, inverterCost_net, gridExtension, capex_net,
          annualProd_net, exportKWh_net, importKWh_net, annualBill_net,

          // Off-grid
          pvKW_off, modules_off, inverterKW_off,
          bankRatedKWh, estUnits, batteryCapex, panelsCost_off, bosCost_off, inverterCost_off, capex_off,

          // LCOE
          lcoe_net, lcoe_off,
          ratio: lcoe_off / Math.max(lcoe_net,1e-9),

          // Common
          kWhPerKWyr, unitKWh_fromVAh
        };
      }, [i]);

      // ---------- UI bits ----------
      const Field = ({ label, suffix, step = 0.01, min = 0, value, onChange, title }) => (
        <label className="grid items-center gap-2 py-1 [grid-template-columns:1fr_8rem_5rem]" title={title||''}>
          <span className="text-sm text-slate-600">{label}</span>
          <input type="number" step={step} min={min}
                 value={Number.isFinite(value) ? value : ''}
                 onChange={(e)=>onChange(parseFloat(e.target.value))}
                 className="h-9 w-full rounded-md border border-slate-300 px-2 text-right"/>
          {suffix && <span className="text-xs text-slate-500 text-left">{suffix}</span>}
        </label>
      );

      const Card = ({title,children}) => (
        <div className="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
          <h3 className="mb-3 text-lg font-semibold text-slate-800">{title}</h3>
          {children}
        </div>
      );

      const Stat = ({label,value,unit=''}) => (
        <div className="flex flex-col rounded-xl bg-slate-50 p-3 text-center">
          <div className="text-2xl font-semibold text-slate-800">
            {isFinite(value) ? value.toLocaleString(undefined,{maximumFractionDigits:3}) : '—'}{unit}
          </div>
          <div className="text-xs text-slate-500">{label}</div>
        </div>
      );

      return (
        <div className="space-y-6">
          <p className="text-sm text-slate-600">
            Enter your load, irradiance, component details, and grid economics. The tool sizes a
            <b> net-zero grid-tie</b> array and an <b>off-grid</b> PV + battery system, then compares CAPEX and LCOE.
          </p>

          {/* Input groups */}
          <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
            <Card title="1) Load">
              <Field label="Annual Load" suffix="kWh/yr" value={i.annualLoadKWh} onChange={v=>set('annualLoadKWh',v)} />
              <Field label="Avg Daily Load" suffix="kWh/day" value={i.avgDailyKWh} onChange={v=>set('avgDailyKWh',v)} />
            </Card>

            <Card title="2) Site Solar">
              <Field label="Irradiance (PSH)" suffix="kWh/m²/day" value={i.irradiancePSH} onChange={v=>set('irradiancePSH',v)}
                     title="Peak Sun Hours ≈ average kWh/m²/day" />
              <Field label="Performance Ratio" suffix="0–1" step={0.01} value={i.performanceRatio} onChange={v=>set('performanceRatio',v)} />
              <div className="text-xs text-slate-500 mt-2">
                Yield per 1 kW: {out.kWhPerKWyr.toFixed(0).toLocaleString()} kWh/yr
              </div>
            </Card>

            <Card title="3) Grid Distance">
              <Field label="Distance from Grid" suffix="ft" value={i.distanceFromGridFt} onChange={v=>set('distanceFromGridFt',v)} />
              <Field label="Cost per Foot" suffix="$ / ft" value={i.costPerFoot} onChange={v=>set('costPerFoot',v)} />
            </Card>
          </div>

          <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
            <Card title="4) Panels & Install">
              <Field label="Panel Size" suffix="W" value={i.panelWatt} onChange={v=>set('panelWatt',v)} />
              <Field label="Panel Price" suffix="$ / panel" value={i.panelPriceUSD} onChange={v=>set('panelPriceUSD',v)} />
              <Field label="BOS Cost" suffix="$ / Wdc" value={i.bosCostPerW} onChange={v=>set('bosCostPerW',v)} />
              <Field label="Install (lump sum)" suffix="$" value={i.installLumpSum} onChange={v=>set('installLumpSum',v)} />
              <Field label="Off-Grid PV Oversize" suffix="×" value={i.oversizeFactorOffGrid} onChange={v=>set('oversizeFactorOffGrid',v)} />
            </Card>

            <Card title="5) Battery Bank">
              <Field label="Bank Voltage" suffix="V" value={i.battVoltage} onChange={v=>set('battVoltage',v)} />
              <Field label="Ah per Battery (info)" suffix="Ah" value={i.battAhPerUnit} onChange={v=>set('battAhPerUnit',v)} />
              <Field label="Depth of Discharge" suffix="%" value={i.battDoD} onChange={v=>set('battDoD',v)} />
              <Field label="Days of Autonomy" suffix="days" step={1} value={i.battDaysAutonomy} onChange={v=>set('battDaysAutonomy',v)} />
              <Field label="Round-Trip Efficiency" suffix="0–1" value={i.battRoundTripEff} onChange={v=>set('battRoundTripEff',v)} />
              <Field label="Battery Cost" suffix="$ / kWh (rated)" value={i.batteryCostPerKWh} onChange={v=>set('batteryCostPerKWh',v)} />
            </Card>

            <Card title="6) Inverters">
              <Field label="Grid-Tie Inverter Size" suffix="kW" value={i.inverterBuyKW} onChange={v=>set('inverterBuyKW',v)} />
              <Field label="Grid-Tie Cost" suffix="$ / kW" value={i.inverterCostPerKW} onChange={v=>set('inverterCostPerKW',v)} />
              <Field label="Off-Grid Inverter Size" suffix="kW" value={i.inverterOffGridKW} onChange={v=>set('inverterOffGridKW',v)} />
              <Field label="Off-Grid Cost" suffix="$ / kW" value={i.inverterOffGridCostPerKW} onChange={v=>set('inverterOffGridCostPerKW',v)} />
            </Card>
          </div>

          <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
            <Card title="7) Buy/Sell & 8) Financials">
              <Field label="Buy Rate" suffix="$ / kWh" value={i.buyRate} onChange={v=>set('buyRate',v)} />
              <Field label="Sell Credit" suffix="$ / kWh" value={i.sellRate} onChange={v=>set('sellRate',v)} />
              <Field label="Discount Rate" suffix="%" value={i.discountRatePct} onChange={v=>set('discountRatePct',v)} />
              <Field label="Analysis Horizon" suffix="yrs" step={1} value={i.analysisYears} onChange={v=>set('analysisYears',v)} />
              <Field label="O&M" suffix="% of CAPEX / yr" value={i.onmPctOfCapex} onChange={v=>set('onmPctOfCapex',v)} />
              <Field label="Generator Reserve (off-grid)" suffix="$ / yr" value={i.generatorReservePerYear} onChange={v=>set('generatorReservePerYear',v)} />
            </Card>

            <Card title="Net-Zero Grid-Tie (Results)">
              <div className="grid grid-cols-2 gap-3">
                <Stat label="Array Size" value={out.pvKW_netzero} unit=" kW" />
                <Stat label="Modules" value={out.modules_net} />
                <Stat label="Inverter Size" value={out.inverterKW_net} unit=" kW" />
                <Stat label="Grid Extension" value={out.gridExtension} unit=" $" />
                <Stat label="CAPEX (all-in)" value={out.capex_net} unit=" $" />
                <Stat label="Annual Prod." value={out.annualProd_net} unit=" kWh/yr" />
                <Stat label="Annual Bill (− credit)" value={out.annualBill_net} unit=" $" />
              </div>
              <div className="text-xs text-slate-500 mt-2">
                CAPEX = Panels + BOS + Inverter + Install + Grid Extension.
              </div>
            </Card>

            <Card title="Off-Grid (Results)">
              <div className="grid grid-cols-2 gap-3">
                <Stat label="PV Size" value={out.pvKW_off} unit=" kW" />
                <Stat label="Modules" value={out.modules_off} />
                <Stat label="Battery (rated)" value={out.bankRatedKWh} unit=" kWh" />
                <Stat label="Est. Battery Units" value={out.estUnits} />
                <Stat label="Inverter Size" value={out.inverterKW_off} unit=" kW" />
                <Stat label="Battery Cost" value={out.batteryCapex} unit=" $" />
                <Stat label="CAPEX (all-in)" value={out.capex_off} unit=" $" />
              </div>
              <div className="text-xs text-slate-500 mt-2">
                CAPEX = Panels + BOS + Off-Grid Inverter + Batteries + Install (no grid extension).
              </div>
            </Card>
          </div>

          <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
            <Card title="LCOE Comparison">
              <div className="grid grid-cols-3 gap-3">
                <Stat label="Net-Zero LCOE" value={out.lcoe_net} unit=" $/kWh" />
                <Stat label="Off-Grid LCOE" value={out.lcoe_off} unit=" $/kWh" />
                <Stat label="Off-Grid / Net-Zero" value={out.ratio} unit=" ×" />
              </div>
              <p className="mt-3 text-xs text-slate-500">
                Annualized cost via capital recovery factor (CRF). Batteries are annualized with a 12-year replacement proxy.
              </p>
            </Card>

            <Card title="Cost Breakdown (Net-Zero)">
              <ul className="text-sm text-slate-700 space-y-1">
                <li>Panels: ${out.panelsCost_net.toLocaleString()}</li>
                <li>BOS: ${out.bosCost_net.toLocaleString()}</li>
                <li>Inverter: ${out.inverterCost_net.toLocaleString()}</li>
                <li>Install: ${i.installLumpSum.toLocaleString()}</li>
                <li>Grid Extension: ${out.gridExtension.toLocaleString()}</li>
              </ul>
            </Card>

            <Card title="Cost Breakdown (Off-Grid)">
              <ul className="text-sm text-slate-700 space-y-1">
                <li>Panels: ${out.panelsCost_off.toLocaleString()}</li>
                <li>BOS: ${out.bosCost_off.toLocaleString()}</li>
                <li>Off-Grid Inverter: ${out.inverterCost_off.toLocaleString()}</li>
                <li>Batteries: ${out.batteryCapex.toLocaleString()}</li>
                <li>Install: ${i.installLumpSum.toLocaleString()}</li>
              </ul>
            </Card>
          </div>

          <div className="text-xs text-slate-500">
            Notes: Uses annual averages; does not model hourly/seasonal tariffs or generator fuel. For engineering design, run time-series (e.g., PVWatts + tariff engine) and utility-specific interconnect rules.
          </div>
        </div>
      );
    }

    function mountTool(){
      const root = ReactDOM.createRoot(document.getElementById('tool-root'));
      root.render(<App />);
    }
  </script>
</body>
</html>
